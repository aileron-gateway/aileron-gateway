name: Unit Test

on:
  push:
    branches: ["**"]
    tags: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  proto:
    uses: ./.github/workflows/proto.yaml
    permissions:
      contents: write

  test:
    needs: proto
    runs-on: ${{ matrix.os }}-latest
    timeout-minutes: 10
    strategy:
      matrix:
        os:
          - ubuntu
          - windows
          - macos
    steps:
      - run: git config --global core.autocrlf false
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: make test
        run: |
          set +o pipefail
          make test 2>&1 | tee _output/unit-test.log
      - uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: ./_output/coverage.out
          fail_ci_if_error: true
          verbose: true
          env_vars: ${{ matrix.os }}
          name: ${{ matrix.os }}
          flags: unit
      - uses: actions/upload-artifact@v4
        with:
          name: unit-test-${{ matrix.os }}
          path: |
            _output/**
            api.html
          retention-days: 1

  # qemu:
  #   needs: proto
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #   strategy:
  #     matrix:
  #       arch:
  #         - { go: "amd64", qemu: "x86_64" }
  #         - { go: "arm", qemu: "arm" }
  #         - { go: "arm64", qemu: "aarch64" }
  #         - { go: "ppc64", qemu: "ppc64" }
  #         - { go: "ppc64le", qemu: "ppc64le" }
  #         - { go: "riscv64", qemu: "riscv64" }
  #         - { go: "s390x", qemu: "s390x" }
  #   steps:
  #     - run: git config --global core.autocrlf false
  #     - uses: actions/checkout@v4
  #     - uses: actions/download-artifact@v4
  #     - uses: actions/setup-go@v5
  #       with:
  #         go-version: stable
  #     - run: |
  #         sudo add-apt-repository -y ppa:canonical-server/server-backports
  #         sudo apt -y update
  #         sudo apt -y install qemu-user
  #     - name: make test
  #       run: |
  #         mkdir -p test-bin/
  #         GOARCH=${{ matrix.arch.go }}	go test -v -cover -c -o test-bin/cmd/ ./cmd/...
  #         GOARCH=${{ matrix.arch.go }} go test -v -cover -c -o test-bin/kernel/ ./kernel/...
  #         GOARCH=${{ matrix.arch.go }} go test -v -cover -c -o test-bin/core/ ./core/...
  #         GOARCH=${{ matrix.arch.go }} go test -v -cover -c -o test-bin/app/ ./app/...
  #         for target in ./test-bin/*; do
  #           echo "RUNNING TEST: ${target}"
  #           TEST_DIR=./test/ qemu-${{ matrix.arch.qemu }} ${target}
  #         done
