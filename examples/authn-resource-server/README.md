# Resource Server Example

This folder is the example of a resource server.

## Pre-requisite

This example uses [keycloak](https://www.keycloak.org/) as authorization server.

Keycloak with necessary configuration and data is in [../../_devtools/keycloak/](../../_devtools/keycloak/).
So, an instance of keycloak should be run with `docker-compose`.

- Run keycloak: `docker-compose up`
- Stop keycloak: `docker-compose down`

## Run

To run this example, run the command below.
Note that the [Pre-requisite](#pre-requisite) have to be met beforehand.

```bash
./aileron -f _example/authn-resource-server/
```

## Test

First, we try to send a HTTP request without any tokens.
An unauthorized response will be returned for such a request as shown below.

```json
$ curl http://localhost:8080/test
{"status":401,"statusText":"Unauthorized"}
```

Next, we try to send a HTTP request with a valid token.
The token can be obtained from token endpoint of the keycloak.

This is an example to get a token from the keycloak.
ROPC (Resource Owner Password Credentials Flow) is used here.

```bash
curl -H "Authorization: Basic YWlsZXJvbl9yb3BjOmMzbEFwVmt2aExucFowMVhCeHNoY0p6WTlGR3NxMzBx" -d "username=test&password=password&grant_type=password&scope=openid" http://localhost:18080/realms/aileron/protocol/openid-connect/token
```

The keycloak will respond a json like this (output is formatted for readability).
We can find `access_token` in the response that we wanted to get.

```json
{
   "access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ4RnptNEJZZ2ktQTB1ek85UHBqZ1htU1M5SHJzTFpQaGMwSXJIOGhlZFg0In0.eyJleHAiOjE3MDkyMTc5ODcsImlhdCI6MTcwOTIxNzY4NywianRpIjoiOWQ4NzUwZjItNDA0OC00N2ZmLTk1ZTQtNDIwYmY0MzI3ZmYxIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxODA4MC9yZWFsbXMvYWlsZXJvbiIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiJlZTMwNjlmNy00ZGMzLTRmZmEtYjI5MC02YjZjOGE4NDg1MzciLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJhaWxlcm9uX3JvcGMiLCJzZXNzaW9uX3N0YXRlIjoiMzljYzU2MzItNzAzZi00YzA5LTgwZWYtMjFmMDgwN2Y3MTBlIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIiwiZGVmYXVsdC1yb2xlcy1haWxlcm9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgZW1haWwgcHJvZmlsZSIsInNpZCI6IjM5Y2M1NjMyLTcwM2YtNGMwOS04MGVmLTIxZjA4MDdmNzEwZSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiZm9vIGJhciIsInByZWZlcnJlZF91c2VybmFtZSI6InRlc3QiLCJnaXZlbl9uYW1lIjoiZm9vIiwiZmFtaWx5X25hbWUiOiJiYXIiLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20ifQ.hiaSdU7Mi4sAWL_cQhVqze0imJK04N8DveNTig9K5pci-2LtZgp9VhgQC4hFoUD_1CzKPWZbbCcDZ4c8Ce9fZtEZOgG1xvXeC9nf62fPLtaf_RWjB4QQKpuNHJ1500cuhg0aJR9iNlvHXplfmGo9GHXZnZD6p6kV2rgMBOzdIveCDgzBELkMhn5-Z3NoFFvExjAEbjsIuFW8GnKzhA5lJ7Izalgcw9ziqP2u3WhmEfgQY9Z_claMUPEnxQMsrOszsrcJFBkmFWZ4tdJBvME_aV-xebQc8XHA6y-k42adSq49vR7_-ok9jmwgw-D_UP5U4CfxnDvfiL3I2goavqw6_w",
   "expires_in":300,
   "refresh_expires_in":1800,
   "refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIzNGRkYjg2MS1hYTlkLTQ3MzEtYjU5Ni1kNjExYzNjNDAwMzUifQ.eyJleHAiOjE3MDkyMTk0ODcsImlhdCI6MTcwOTIxNzY4NywianRpIjoiZjhiN2JiMDYtOWVjMC00ZmE0LTgzZjctYzkxNTBjN2Q0NGVjIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxODA4MC9yZWFsbXMvYWlsZXJvbiIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MTgwODAvcmVhbG1zL2FpbGVyb24iLCJzdWIiOiJlZTMwNjlmNy00ZGMzLTRmZmEtYjI5MC02YjZjOGE4NDg1MzciLCJ0eXAiOiJSZWZyZXNoIiwiYXpwIjoiYWlsZXJvbl9yb3BjIiwic2Vzc2lvbl9zdGF0ZSI6IjM5Y2M1NjMyLTcwM2YtNGMwOS04MGVmLTIxZjA4MDdmNzEwZSIsInNjb3BlIjoib3BlbmlkIGVtYWlsIHByb2ZpbGUiLCJzaWQiOiIzOWNjNTYzMi03MDNmLTRjMDktODBlZi0yMWYwODA3ZjcxMGUifQ.kbSSiY6iZ7RP3enSEAsgXNA07Mjmgsfd04P2GZ8L6H0",
   "token_type":"Bearer",
   "id_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ4RnptNEJZZ2ktQTB1ek85UHBqZ1htU1M5SHJzTFpQaGMwSXJIOGhlZFg0In0.eyJleHAiOjE3MDkyMTc5ODcsImlhdCI6MTcwOTIxNzY4NywiYXV0aF90aW1lIjowLCJqdGkiOiIxY2FjYWFhMC02M2JmLTQxMzEtYjQ1My1hNjY3OWI4ZDIxOTYiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjE4MDgwL3JlYWxtcy9haWxlcm9uIiwiYXVkIjoiYWlsZXJvbl9yb3BjIiwic3ViIjoiZWUzMDY5ZjctNGRjMy00ZmZhLWIyOTAtNmI2YzhhODQ4NTM3IiwidHlwIjoiSUQiLCJhenAiOiJhaWxlcm9uX3JvcGMiLCJzZXNzaW9uX3N0YXRlIjoiMzljYzU2MzItNzAzZi00YzA5LTgwZWYtMjFmMDgwN2Y3MTBlIiwiYXRfaGFzaCI6IklVZlQwc0tjbXEydTdKSW0ycXBIQnciLCJhY3IiOiIxIiwic2lkIjoiMzljYzU2MzItNzAzZi00YzA5LTgwZWYtMjFmMDgwN2Y3MTBlIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm5hbWUiOiJmb28gYmFyIiwicHJlZmVycmVkX3VzZXJuYW1lIjoidGVzdCIsImdpdmVuX25hbWUiOiJmb28iLCJmYW1pbHlfbmFtZSI6ImJhciIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSJ9.JfpI-3Vkpb9wisJ1F5ieyA56jmbKRyJv4b-PhQFDSLa7pn6TWqszYE5k-qS9k-RjHLI6eGInBlT9-c87WTJ25F5BRKzf1vWsgO35GT05hFYoqnVMLGA6pUxcS9zrtRsFf24-NUNg2OHYFEdVFrnQIz5hh72T9vamK1pYFa_pVuv8hcTAtN64qlSEuC3iIupH1_U94cg6bLzM2_NkJ9s-sRDRL08a3_sKdE36osUAWvz-ozYBWRHBtXwEUPVx1SxBxwKTdSyulnbMCVcuwLhfpLpN03Fs7LanxzGQcIG9ZDE2Sg4pXdDu_zdIZ5PgSorg4lpAqHI34TYMpyvMWVQOkQ",
   "not-before-policy":1684309880,
   "session_state":"39cc5632-703f-4c09-80ef-21f0807f710e",
   "scope":"openid email profile"
}
```

Now, send a HTTP request with the access token.

```bash
curl -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ4RnptNEJZZ2ktQTB1ek85UHBqZ1htU1M5SHJzTFpQaGMwSXJIOGhlZFg0In0.eyJleHAiOjE3MDkyMTc5ODcsImlhdCI6MTcwOTIxNzY4NywianRpIjoiOWQ4NzUwZjItNDA0OC00N2ZmLTk1ZTQtNDIwYmY0MzI3ZmYxIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxODA4MC9yZWFsbXMvYWlsZXJvbiIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiJlZTMwNjlmNy00ZGMzLTRmZmEtYjI5MC02YjZjOGE4NDg1MzciLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJhaWxlcm9uX3JvcGMiLCJzZXNzaW9uX3N0YXRlIjoiMzljYzU2MzItNzAzZi00YzA5LTgwZWYtMjFmMDgwN2Y3MTBlIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIiwiZGVmYXVsdC1yb2xlcy1haWxlcm9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgZW1haWwgcHJvZmlsZSIsInNpZCI6IjM5Y2M1NjMyLTcwM2YtNGMwOS04MGVmLTIxZjA4MDdmNzEwZSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiZm9vIGJhciIsInByZWZlcnJlZF91c2VybmFtZSI6InRlc3QiLCJnaXZlbl9uYW1lIjoiZm9vIiwiZmFtaWx5X25hbWUiOiJiYXIiLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20ifQ.hiaSdU7Mi4sAWL_cQhVqze0imJK04N8DveNTig9K5pci-2LtZgp9VhgQC4hFoUD_1CzKPWZbbCcDZ4c8Ce9fZtEZOgG1xvXeC9nf62fPLtaf_RWjB4QQKpuNHJ1500cuhg0aJR9iNlvHXplfmGo9GHXZnZD6p6kV2rgMBOzdIveCDgzBELkMhn5-Z3NoFFvExjAEbjsIuFW8GnKzhA5lJ7Izalgcw9ziqP2u3WhmEfgQY9Z_claMUPEnxQMsrOszsrcJFBkmFWZ4tdJBvME_aV-xebQc8XHA6y-k42adSq49vR7_-ok9jmwgw-D_UP5U4CfxnDvfiL3I2goavqw6_w" http://localhost:8080/test
```

The request will be authorized and non-error response will be responded.
The following output is an example.

```text
========== Request ==========
Method : GET
URI    : /test
Path   : /test
Query  :
Remote : [::1]:41508
========== Header ==========
{
  "Accept": [
    "*/*"
  ],
  "Authorization": [
    "Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ4RnptNEJZZ2ktQTB1ek85UHBqZ1htU1M5SHJzTFpQaGMwSXJIOGhlZFg0In0.eyJleHAiOjE3MDkyMTc5ODcsImlhdCI6MTcwOTIxNzY4NywianRpIjoiOWQ4NzUwZjItNDA0OC00N2ZmLTk1ZTQtNDIwYmY0MzI3ZmYxIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDoxODA4MC9yZWFsbXMvYWlsZXJvbiIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiJlZTMwNjlmNy00ZGMzLTRmZmEtYjI5MC02YjZjOGE4NDg1MzciLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJhaWxlcm9uX3JvcGMiLCJzZXNzaW9uX3N0YXRlIjoiMzljYzU2MzItNzAzZi00YzA5LTgwZWYtMjFmMDgwN2Y3MTBlIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIiwiZGVmYXVsdC1yb2xlcy1haWxlcm9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgZW1haWwgcHJvZmlsZSIsInNpZCI6IjM5Y2M1NjMyLTcwM2YtNGMwOS04MGVmLTIxZjA4MDdmNzEwZSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiZm9vIGJhciIsInByZWZlcnJlZF91c2VybmFtZSI6InRlc3QiLCJnaXZlbl9uYW1lIjoiZm9vIiwiZmFtaWx5X25hbWUiOiJiYXIiLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20ifQ.hiaSdU7Mi4sAWL_cQhVqze0imJK04N8DveNTig9K5pci-2LtZgp9VhgQC4hFoUD_1CzKPWZbbCcDZ4c8Ce9fZtEZOgG1xvXeC9nf62fPLtaf_RWjB4QQKpuNHJ1500cuhg0aJR9iNlvHXplfmGo9GHXZnZD6p6kV2rgMBOzdIveCDgzBELkMhn5-Z3NoFFvExjAEbjsIuFW8GnKzhA5lJ7Izalgcw9ziqP2u3WhmEfgQY9Z_claMUPEnxQMsrOszsrcJFBkmFWZ4tdJBvME_aV-xebQc8XHA6y-k42adSq49vR7_-ok9jmwgw-D_UP5U4CfxnDvfiL3I2goavqw6_w"
  ],
  "User-Agent": [
    "curl/7.68.0"
  ]
}
========== Body ==========

==========================
```
